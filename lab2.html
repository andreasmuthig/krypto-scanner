<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Krypto-Scanner LAB – Icons & Farbstil</title>
  <script src="https://unpkg.com/feather-icons"></script>
  <style>
    body {
      background-color: #111;
      color: #eee;
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      padding: 12px;
      border-bottom: 1px solid #444;
      text-align: center;
    }
    th {
      background-color: #222;
    }
    a {
      color: #4fc3f7;
      text-decoration: none;
    }
    .led {
      width: 16px;
      height: 16px;
      border-radius: 4px;
      margin: 2px;
      display: inline-block;
    }
    .led-on { background-color: #00ff88; }
    .led-off { background-color: #444; }

    .row-pair-1a { background-color: #1d1f20; }
    .row-pair-1b { background-color: #2c2d2e; }
    .row-pair-2a { background-color: #202223; }
    .row-pair-2b { background-color: #312c28; }
  </style>
</head>
<body>
  <h1>Krypto-Scanner LAB – mit Icons & Trendfarben</h1>
  <div id="output">Lade Daten…</div>

  <script>
    async function fetchData(symbol, pairIndex = 0) {
      const [tickerRes, klineRes] = await Promise.all([
        fetch(`https://api.binance.com/api/v3/ticker/24hr?symbol=${symbol}`),
        fetch(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=1h&limit=100`)
      ]);
      const ticker = await tickerRes.json();
      const klines = await klineRes.json();

      const kurs = parseFloat(ticker.lastPrice);
      const einstieg = kurs * 0.995;
      const tp1 = kurs * 1.015;
      const tp2 = kurs * 1.03;
      const stop = kurs * 0.99;
      const crv = ((tp1 - einstieg) / (einstieg - stop)).toFixed(2);
      const change1h = (((kurs - parseFloat(klines[klines.length - 2][4])) / parseFloat(klines[klines.length - 2][4])) * 100).toFixed(2);
      const change24h = parseFloat(ticker.priceChangePercent).toFixed(2);
      const volume = parseFloat(ticker.volume).toFixed(2);

      // RSI (echte Daten, 14 Perioden)
      const closes = klines.map(k => parseFloat(k[4]));
      let gains = 0, losses = 0;
      for (let i = 1; i < 15; i++) {
        const diff = closes[i] - closes[i - 1];
        if (diff >= 0) gains += diff;
        else losses -= diff;
      }
      const avgGain = gains / 14;
      const avgLoss = losses / 14;
      const rs = avgLoss === 0 ? 100 : avgGain / avgLoss;
      const rsi = avgLoss === 0 ? 100 : (100 - (100 / (1 + rs))).toFixed(0);

      // MACD
      const ema = (data, period) => {
        const k = 2 / (period + 1);
        return data.reduce((acc, val, i) => {
          if (i === 0) acc.push(val);
          else acc.push(val * k + acc[i - 1] * (1 - k));
          return acc;
        }, []);
      };
      const ema12 = ema(closes, 12);
      const ema26 = ema(closes, 26);
      const macdLine = ema12.map((v, i) => v - ema26[i]);
      const signalLine = ema(macdLine.slice(26), 9);
      const macdHist = macdLine.slice(26).map((v, i) => v - signalLine[i]);
      const macdTrend = macdHist.at(-1) > macdHist.at(-2) ? "⬆️" : "⬇️";

      const ema50 = ema(closes, 50).at(-1);
      const ema200 = ema(closes, 200).at(-1);
      const emaTrend = ema50 > ema200 ? "📈" : "📉";

      const crvFloat = parseFloat(crv);
      let crvLevel = 0;
      if (crvFloat >= 1.0) crvLevel = 1;
      if (crvFloat >= 1.5) crvLevel = 2;
      if (crvFloat >= 2.0) crvLevel = 3;
      if (crvFloat >= 2.5) crvLevel = 4;

      let rsiLevel = 0;
      if (rsi < 25) rsiLevel = 4;
      else if (rsi < 50) rsiLevel = 3;
      else if (rsi < 70) rsiLevel = 2;
      else rsiLevel = 1;

      const led = (val) => `<span class="led ${val ? 'led-on' : 'led-off'}"></span>`;
      const ledBar = (level) => Array.from({ length: 4 }, (_, i) => led(i < level)).join('');

      const styleA = pairIndex % 2 === 0 ? "row-pair-1a" : "row-pair-2a";
      const styleB = pairIndex % 2 === 0 ? "row-pair-1b" : "row-pair-2b";

      document.getElementById("output").innerHTML += `
        <table>
          <tr class="${styleA}">
            <td><a href="coin.html?symbol=${symbol}" target="_self">${symbol}</a></td>
            <td>${kurs.toFixed(2)} USDT</td>
            <td>${einstieg.toFixed(2)}</td>
            <td>${tp1.toFixed(2)}<br/>${tp2.toFixed(2)}</td>
            <td>${stop.toFixed(2)}</td>
            <td>${crv}<br/>${ledBar(crvLevel)}</td>
            <td>${rsi}<br/>${ledBar(rsiLevel)}</td>
            <td>${change1h}%</td>
            <td>${change24h}%</td>
          </tr>
          <tr class="${styleB}">
            <td colspan="9" style="text-align: left; padding-left: 30px;">
              <i data-feather="activity"></i> EMA: ${emaTrend} &nbsp;&nbsp;
              <i data-feather="trending-${macdTrend === '⬆️' ? 'up' : 'down'}"></i> MACD: ${macdTrend} &nbsp;&nbsp;
              <i data-feather="bar-chart-2"></i> Volumen: ${volume}
            </td>
          </tr>
        </table>
      `;
      feather.replace();
    }

    fetchData("BTCUSDT", 0);
  </script>
</body>
</html>
