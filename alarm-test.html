<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Alarm Test</title>
  <link rel="stylesheet" href="style-alarm.css">
  <script src="https://unpkg.com/feather-icons"></script>
</head>
<body>

<audio id="alarmSound" src="alert.mp3" preload="auto"></audio>
<button id="startButton">AlarmÃ¼berwachung starten</button>
<div id="status" style="margin-top: 10px; font-weight: bold;"></div>
<div id="alarms-container"></div>

<script>
const alarmSound = document.getElementById("alarmSound");
const alarmsContainer = document.getElementById("alarms-container");
const startButton = document.getElementById("startButton");
const statusDiv = document.getElementById("status");
let isMonitoring = false;

function triggerAlarm(coin, entry, price, index) {
  if (!coin || document.getElementById("alarm-" + coin)) return;

  const box = document.createElement("div");
  box.className = "alarm-box";
  box.id = "alarm-" + coin;
  box.style.left = (10 + index * 220) + "px";

  const now = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

  box.innerHTML = `
    <div class="alarm-header">
      <strong>${coin}</strong>
      <span style="float:right;">ðŸ•“ ${now}</span>
      <div class="alarm-icons">
        <a href="coin.html?symbol=${coin}" target="_blank"><i data-feather="external-link"></i></a>
        <i class="close-btn" data-feather="x"></i>
      </div>
    </div>
    <div class="alarm-body">
      <div>ðŸ“‰ <strong>Kurs:</strong> ${price.toFixed(2)} USDT</div>
      <div>ðŸŽ¯ <strong>Einstieg:</strong> ${entry.toFixed(2)} USDT</div>
      <div style="color:#888; font-size: 12px;">Alarm ausgelÃ¶st â€“ 1,5â€¯% vor Einstieg</div>
    </div>
  `;

  alarmsContainer.appendChild(box);
  feather.replace();

  alarmSound.play().then(() => {
    console.log("Sound erfolgreich abgespielt!");
  }).catch(error => {
    console.error("Fehler beim Abspielen des Sounds:", error);
    if (Notification.permission === "granted") {
      new Notification(`Alarm fÃ¼r ${coin}! Kurs: ${price.toFixed(2)} USDT`);
    }
  });

  box.querySelector(".close-btn").onclick = () => box.remove();

  let offsetX;
  const drag = (e) => {
    box.style.left = (e.clientX - offsetX) + "px";
  };
  box.onmousedown = (e) => {
    offsetX = e.clientX - box.getBoundingClientRect().left;
    document.addEventListener("mousemove", drag);
    document.addEventListener("mouseup", () => {
      document.removeEventListener("mousemove", drag);
    }, { once: true });
  };
}

startButton.addEventListener("click", () => {
  alarmSound.play().then(() => {
    alarmSound.pause();
    isMonitoring = true;
    statusDiv.textContent = "Ãœberwachung aktiv...";
    statusDiv.style.color = "green";
    startButton.style.display = "none";
    setTimeout(() => {
      triggerAlarm("BTCUSDT", 67920.00, 67800.00, 0);
      triggerAlarm("ETHUSDT", 3500.00, 3498.92, 1);
      triggerAlarm("SOLUSDT", 185.00, 184.96, 2);
    }, 1000);
  }).catch(err => {
    console.error("Audio nicht freigegeben:", err);
    alert("Bitte erlaube die Soundwiedergabe.");
  });
});
</script>

</body>
</html>
